# Telethon Fancifier

![Python](https://img.shields.io/badge/python-3.12+-blue.svg)
![Platform](https://img.shields.io/badge/platform-linux%20%7C%20macos%20%7C%20windows-lightgrey)
![Telethon](https://img.shields.io/badge/telethon-1.37+-blue)
![Code Style](https://img.shields.io/badge/code%20style-ruff-000000.svg)
![Type Checker](https://img.shields.io/badge/type%20checker-mypy-blue)
![Tests](https://img.shields.io/badge/tests-pytest-green)

Telegram-демон на базе Telethon, который автоматически трансформирует последнее сообщение в выбранных чатах через настраиваемый конвейер плагинов.

## Обзор

Telethon Fancifier отслеживает ваши сообщения в Telegram и применяет текстовые трансформации на основе конфигурации плагинов для каждого чата. Система поддерживает встроенные плагины, переписывание через LLM и пользовательские плагины с безопасным режимом dry-run для тестирования.

## Возможности

**Основной функционал**
- Модульная архитектура плагинов для трансформации текста
- Настройка и упорядочивание плагинов для каждого чата
- Сохранение конфигурации между перезапусками
- Режим dry-run для безопасного тестирования без реального редактирования
- Платформо-зависимое хранилище данных приложения

**Механизмы безопасности**
- Редактирование только сообщений младше 10 секунд
- Изменение только вашего последнего сообщения в целевых чатах
- Комплексная обработка ошибок с детальным логированием
- Интерактивное подтверждение деструктивных операций

**Автоматическая перезагрузка конфигурации**
- По умолчанию включена автоматическая перезагрузка конфигурации
- Изменения в конфиге применяются без перезапуска демона
- Перестройка реестра плагинов при обновлении настроек LLM
- Используйте `--no-hot-reload` для отключения

**Портативный режим**
- Флаг `--portable` сохраняет все данные в `./data/` вместо системной директории
- Включает конфигурацию, логи и сессии Telegram
- Идеально для запуска с USB-носителей или в изолированных средах
- Установить переменную окружения: `TELETHON_FANCIFIER_PORTABLE=1`
- Поддержка нескольких LLM-провайдеров (реализован DeepSeek)
- Настраиваемые prompt-профили с кастомными системными и пользовательскими промптами
- Настройка temperature для каждого профиля
- Поддержка API-стилей `chat_completions` и `responses`
- Автономное тестирование LLM без подключения к Telegram

**Поддержка Windows**
- Portable ZIP релизы через PyInstaller
- Интеграция с планировщиком задач для автозапуска
- PowerShell и batch скрипты для обновления
- Интерактивный CLI для управления задачами

## Встроенные плагины

| Плагин | Описание |
|--------|----------|
| `llm_rewrite` | Трансформирует сообщения через LLM API (по умолчанию DeepSeek) |
| `random_bold` | Случайно применяет markdown-форматирование жирным шрифтом к символам |
| `every_second_upper` | Преобразует каждый второй символ в верхний регистр |

## Установка

### Предварительные требования
- Python 3.12 или выше
- Учётные данные Telegram API ([получить здесь](https://my.telegram.org/apps))
- DeepSeek API ключ (опционально, для LLM-функций)

### Настройка

```bash
# Создание виртуального окружения
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# Установка пакета
pip install -e .

# Настройка переменных окружения
cp .env.example .env
# Отредактируйте .env своими учётными данными
```

### Обязательные переменные окружения

```env
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash
TELEGRAM_SESSION_NAME=telethon_fancifier
DEEPSEEK_API_KEY=your_deepseek_key  # Опционально, для LLM-плагина
```

## Быстрый старт

### Интерактивная настройка

Запустите мастер настройки для конфигурации чатов и плагинов:

```bash
telethon-fancifier setup
```

Мастер предоставляет:
- Добавление/изменение чатов с упорядочиванием плагинов
- Удаление чатов из конфигурации
- Просмотр текущих настроек
- Настройка LLM: модель, API-стиль, prompt-профили, temperature
- Интерактивное тестирование LLM

### Запуск демона

```bash
# Обычный режим
telethon-fancifier run

# Режим dry-run (показывает изменения без применения)
telethon-fancifier run --dry-run

# Отключить автоматическую перезагрузку конфигурации
telethon-fancifier run --no-hot-reload

# Портативный режим (использовать ./data вместо системной директории)
telethon-fancifier --portable run
```

**Автоматическая перезагрузка конфигурации**: По умолчанию демон отслеживает изменения в файле конфигурации и автоматически применяет их без перезапуска. Используйте `--no-hot-reload` для отключения этой функции.

### Предпросмотр плагинов

Протестируйте цепочку плагинов без запуска Telegram:

```bash
# Интерактивный ввод с применением всех плагинов
telethon-fancifier preview

# С указанным текстом
telethon-fancifier preview --text "Тестовое сообщение"

# Использовать плагины конкретного чата
telethon-fancifier preview --chat-id 123456789 --text "Текст"

# Применить конкретные плагины в указанном порядке
telethon-fancifier preview --plugins llm_rewrite random_bold --text "Текст"
```

Предпросмотр показывает результат каждого шага трансформации, что удобно для отладки и тестирования конфигурации плагинов.

### Просмотр конфигурации

```bash
telethon-fancifier show-config
```

### Тестирование LLM без Telegram

```bash
telethon-fancifier test-llm --text "Привет, это тест"
```

## CLI команды

| Команда | Описание |
|---------|----------|
| `setup` | Интерактивный мастер для настройки чатов и плагинов |
| `run` | Запуск демона трансформации сообщений |
| `run --dry-run` | Предпросмотр трансформаций без редактирования сообщений |
| `run --no-hot-reload` | Отключить автоматическую перезагрузку конфигурации |
| `--portable <команда>` | Использовать портативный режим (данные в ./data) |
| `preview` | Предпросмотр трансформаций плагинов без Telegram |
| `show-config` | Показать текущую конфигурацию |
| `test-llm` | Тестирование LLM-ответов без подключения к Telegram |
| `remove-chats` | Интерактивное удаление чатов из конфигурации |
| `build-windows` | Сборка portable ZIP-релиза для Windows |
| `install-startup-task` | Создание задачи в планировщике Windows (только Windows) |
| `remove-startup-task` | Удаление задачи из планировщика Windows (только Windows) |
| `startup-task-status` | Проверка статуса задачи автозапуска Windows (только Windows) |

## Структура проекта

```
src/telethon_fancifier/
├── core/              # Демон, защитные механизмы, утилиты
│   ├── daemon.py      # Основной демон мониторинга сообщений
│   ├── safeguards.py  # Проверки безопасности редактирования
│   ├── llm_tools.py   # Утилиты интеграции с LLM
│   └── ...
├── plugins/           # Система плагинов и встроенные плагины
│   ├── base.py        # Базовый класс и протокол плагина
│   ├── registry.py    # Реестр плагинов
│   ├── loader.py      # Загрузчик внешних плагинов
│   └── ...
├── providers/         # Абстракции LLM-провайдеров
│   ├── base.py        # Протокол провайдера
│   └── deepseek.py    # Реализация DeepSeek
├── config/            # Управление конфигурацией
│   ├── schema.py      # Модели данных конфигурации
│   └── store.py       # Персистентное хранилище
└── ui/                # Интерактивные CLI-интерфейсы
```

## Разработка пользовательских плагинов

Создавайте плагины в директории `plugins/`. Каждый плагин должен экспортировать функцию `get_plugin()`:

```python
from telethon_fancifier.plugins.base import Plugin, PluginContext

class MyPlugin(Plugin):
    @property
    def plugin_id(self) -> str:
        return "my_plugin"
    
    @property
    def title(self) -> str:
        return "Мой пользовательский плагин"
    
    async def transform(self, text: str, context: PluginContext) -> str:
        # Ваша логика трансформации
        return text.upper()

def get_plugin():
    return MyPlugin()
```

Рабочий пример см. в [plugins/example_reverse.py](plugins/example_reverse.py).

## Развёртывание на Windows

### Сборка Portable-релиза

```bash
# Локальная сборка (только Windows)
pip install pyinstaller
telethon-fancifier build-windows
```

Для кросс-платформенной сборки используйте GitHub Actions workflow `.github/workflows/release.yml`.

### Настройка автозапуска

```bash
# Установка задачи автозапуска
telethon-fancifier install-startup-task --task-name "TelethonFancifier"

# Установка с режимом dry-run
telethon-fancifier install-startup-task --dry-run

# Удаление задачи автозапуска
telethon-fancifier remove-startup-task

# Проверка статуса
telethon-fancifier startup-task-status
```

### Скрипт быстрого обновления

Обновление из `origin/main` с автоматическим бэкапом:

```powershell
.\scripts\windows_quick_update.ps1
```

## Разработка

### Настройка окружения разработки

```bash
pip install -e .[dev]
```

### Качество кода

```bash
# Линтинг
ruff check .

# Проверка типов
mypy src

# Запуск тестов
pytest
```

### Тестирование

Проект включает комплексные тесты:
- Тесты функциональности плагинов
- Тесты конфигурации и интеграции с LLM
- Тесты сохранения конфигурации
- Тесты механизмов защиты
- Тесты задач автозапуска Windows

## Логирование и обработка ошибок

- Ошибки обрабатываются корректно без показа traceback пользователям
- Детальные технические ошибки записываются в платформо-зависимые лог-файлы
- Путь к логу: `app-data/telethon-fancifier/logs/app.log`
- Расположение лога отображается при возникновении ошибки

## Соображения безопасности

- **API-ключи**: Никогда не коммитьте `.env` или учётные данные в систему контроля версий
- **Безопасность аккаунта**: Используйте только с собственными аккаунтами Telegram
- **Приватность LLM**: Плагин `llm_rewrite` отправляет содержимое сообщений внешним API-провайдерам
- **Разрешения**: Следуйте Условиям использования Telegram и правилам использования API

## Документация

- [Детали архитектуры](docs/architecture.md)
- [Руководство по первому dry-run](docs/first-dry-run.md)
- [Разработка плагинов](plugins/README.md)

## Вклад в проект

Вклад приветствуется! Пожалуйста, убедитесь что:
- Код проходит `ruff check` и `mypy src`
- Все тесты проходят с `pytest`
- Новые функции включают соответствующие тесты
- Документация обновлена соответствующим образом

## Благодарности

Собрано с использованием:
- [Telethon](https://github.com/LonamiWebs/Telethon) - библиотека клиента Telegram
- [httpx](https://www.python-httpx.org/) - HTTP-клиент
- [platformdirs](https://github.com/platformdirs/platformdirs) - платформо-зависимые директории

---

**Примечание**: Этот проект предназначен для образовательного и личного использования. Всегда соблюдайте Условия использования Telegram и политики использования API.
